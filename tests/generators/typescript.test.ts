import path from 'node:path';
import fs from 'node:fs';
import { TypeScriptGenerator } from '../../src/generators/typescript';
import { SchemaLoader } from '../../src/loader';
import { TypeSchema } from '../../src/typeschema';

describe('TypeScript Generator', () => {
    const outputDir = path.join(__dirname, '../../tmp/typescript-test');

    beforeEach(() => {
        // Clean output directory
        if (fs.existsSync(outputDir)) {
            fs.rmSync(outputDir, { recursive: true, force: true });
        }
    });

    afterEach(() => {
        // Clean up after test
        if (fs.existsSync(outputDir)) {
            fs.rmSync(outputDir, { recursive: true, force: true });
        }
    });

    test('should generate interface with basic fields', async () => {
        // Create a simple test schema
        const testSchema: TypeSchema = {
            identifier: {
                kind: 'complex-type',
                name: 'ContactPoint',
                package: 'hl7.fhir.r4.core',
                url: 'http://hl7.org/fhir/StructureDefinition/ContactPoint',
            },
            base: {
                kind: 'complex-type',
                name: 'Element',
                package: 'hl7.fhir.r4.core',
                url: 'http://hl7.org/fhir/StructureDefinition/Element',
            },
            dependencies: [
                {
                    kind: 'complex-type',
                    name: 'Element',
                    package: 'hl7.fhir.r4.core',
                    url: 'http://hl7.org/fhir/StructureDefinition/Element',
                },
            ],
            fields: {
                system: {
                    type: {
                        kind: 'primitive-type',
                        name: 'code',
                        package: 'hl7.fhir.r4.core',
                    },
                    required: false,
                    array: false,
                    enum: ['phone', 'fax', 'email', 'pager', 'url', 'sms', 'other'],
                },
                value: {
                    type: {
                        kind: 'primitive-type',
                        name: 'string',
                        package: 'hl7.fhir.r4.core',
                    },
                    required: false,
                    array: false,
                },
                use: {
                    type: {
                        kind: 'primitive-type',
                        name: 'code',
                        package: 'hl7.fhir.r4.core',
                    },
                    required: false,
                    array: false,
                    enum: ['home', 'work', 'temp', 'old', 'mobile'],
                },
            },
        };

        // Create generator
        const gen = new TypeScriptGenerator({
            outputDir,
            typesOnly: true,
        });

        // Mock the loader to return our test schema
        gen.loader.complexTypes = () => [testSchema];
        gen.loader.resources = () => [];
        gen.loader.logicalModels = () => [];
        gen.loader.profiles = () => [];

        // Generate
        gen.generate();

        // Read generated file
        const generatedFile = path.join(outputDir, 'hl7-fhir-r4-core', 'ContactPoint.ts');
        expect(fs.existsSync(generatedFile)).toBe(true);

        const content = fs.readFileSync(generatedFile, 'utf-8');

        // Verify disclaimer
        expect(content).toContain('WARNING: This file is autogenerated');

        // Verify imports
        expect(content).toContain("import { Element } from '../hl7-fhir-r4-core/Element'");

        // Verify interface declaration
        expect(content).toContain('export interface ContactPoint extends Element');

        // Verify fields
        expect(content).toContain("system?: 'phone' | 'fax' | 'email' | 'pager' | 'url' | 'sms' | 'other'");
        expect(content).toContain('_system?: Element');
        expect(content).toContain('value?: string');
        expect(content).toContain('_value?: Element');
        expect(content).toContain("use?: 'home' | 'work' | 'temp' | 'old' | 'mobile'");
        expect(content).toContain('_use?: Element');
    });

    test('should generate interface with array fields', async () => {
        const testSchema: TypeSchema = {
            identifier: {
                kind: 'resource',
                name: 'Patient',
                package: 'hl7.fhir.r4.core',
                url: 'http://hl7.org/fhir/StructureDefinition/Patient',
            },
            base: {
                kind: 'resource',
                name: 'DomainResource',
                package: 'hl7.fhir.r4.core',
                url: 'http://hl7.org/fhir/StructureDefinition/DomainResource',
            },
            dependencies: [
                {
                    kind: 'resource',
                    name: 'DomainResource',
                    package: 'hl7.fhir.r4.core',
                    url: 'http://hl7.org/fhir/StructureDefinition/DomainResource',
                },
                {
                    kind: 'complex-type',
                    name: 'HumanName',
                    package: 'hl7.fhir.r4.core',
                    url: 'http://hl7.org/fhir/StructureDefinition/HumanName',
                },
                {
                    kind: 'complex-type',
                    name: 'Identifier',
                    package: 'hl7.fhir.r4.core',
                    url: 'http://hl7.org/fhir/StructureDefinition/Identifier',
                },
            ],
            fields: {
                active: {
                    type: {
                        kind: 'primitive-type',
                        name: 'boolean',
                        package: 'hl7.fhir.r4.core',
                    },
                    required: false,
                    array: false,
                },
                name: {
                    type: {
                        kind: 'complex-type',
                        name: 'HumanName',
                        package: 'hl7.fhir.r4.core',
                    },
                    required: false,
                    array: true,
                },
                identifier: {
                    type: {
                        kind: 'complex-type',
                        name: 'Identifier',
                        package: 'hl7.fhir.r4.core',
                    },
                    required: false,
                    array: true,
                },
            },
        };

        const gen = new TypeScriptGenerator({
            outputDir,
            typesOnly: true,
        });

        gen.loader.complexTypes = () => [];
        gen.loader.resources = () => [testSchema];
        gen.loader.logicalModels = () => [];
        gen.loader.profiles = () => [];

        gen.generate();

        const generatedFile = path.join(outputDir, 'hl7-fhir-r4-core', 'Patient.ts');
        expect(fs.existsSync(generatedFile)).toBe(true);

        const content = fs.readFileSync(generatedFile, 'utf-8');

        // Verify array types
        expect(content).toContain('name?: HumanName[]');
        expect(content).toContain('identifier?: Identifier[]');
        expect(content).toContain('active?: boolean');
        expect(content).toContain('_active?: Element');
    });

    test('should generate index file with exports', async () => {
        const schema1: TypeSchema = {
            identifier: {
                kind: 'complex-type',
                name: 'Address',
                package: 'hl7.fhir.r4.core',
                url: 'http://hl7.org/fhir/StructureDefinition/Address',
            },
            fields: {},
        };

        const schema2: TypeSchema = {
            identifier: {
                kind: 'complex-type',
                name: 'ContactPoint',
                package: 'hl7.fhir.r4.core',
                url: 'http://hl7.org/fhir/StructureDefinition/ContactPoint',
            },
            fields: {},
        };

        const gen = new TypeScriptGenerator({
            outputDir,
            typesOnly: true,
        });

        gen.loader.complexTypes = () => [schema1, schema2];
        gen.loader.resources = () => [];
        gen.loader.logicalModels = () => [];
        gen.loader.profiles = () => [];

        gen.generate();

        const indexFile = path.join(outputDir, 'hl7-fhir-r4-core', 'index.ts');
        expect(fs.existsSync(indexFile)).toBe(true);

        const content = fs.readFileSync(indexFile, 'utf-8');

        // Verify imports
        expect(content).toContain("import { Address } from './Address'");
        expect(content).toContain("import { ContactPoint } from './ContactPoint'");

        // Verify exports
        expect(content).toContain('export { Address, ContactPoint }');

        // Verify ResourceTypeMap
        expect(content).toContain('export type ResourceTypeMap');
        expect(content).toContain('Address: Address');
        expect(content).toContain('ContactPoint: ContactPoint');

        // Verify ResourceType
        expect(content).toContain('export type ResourceType = keyof ResourceTypeMap');

        // Verify resourceList
        expect(content).toContain('export const resourceList: readonly ResourceType[]');
        expect(content).toContain("'Address'");
        expect(content).toContain("'ContactPoint'");
    });
});
